# HDR色调映射专利可视化工具 - 用户使用手册

## 目录
1. [快速开始](#快速开始)
2. [界面介绍](#界面介绍)
3. [功能详解](#功能详解)
4. [使用示例](#使用示例)
5. [常见问题](#常见问题)
6. [技术规格](#技术规格)

## 快速开始

### 系统要求
- **Python**: 3.8或更高版本
- **内存**: 4GB RAM (推荐8GB)
- **存储**: 1GB可用空间
- **操作系统**: Windows 10+, macOS 10.14+, Linux (Ubuntu 18.04+)

### 安装步骤

1. **克隆项目**
   ```bash
   git clone <repository-url>
   cd hdr-tone-mapping-gradio
   ```

2. **安装依赖**
   ```bash
   pip install -r requirements.txt
   ```

3. **启动应用**
   ```bash
   python src/gradio_app.py
   ```

4. **访问界面**
   - 打开浏览器访问 `http://localhost:7860`
   - 或点击终端中显示的链接

### 5分钟快速体验

1. **启动应用**后，您将看到主界面
2. **调节参数**：拖动"亮度控制因子 p"滑块，观察曲线变化
3. **上传图像**：点击"上传HDR图像"，选择一张图片
4. **处理图像**：点击"处理图像"按钮，查看色调映射结果
5. **导出数据**：点击"导出数据"保存处理结果

## 界面介绍

### 主界面布局

```
┌─────────────────────────────────────────────────────────────┐
│                HDR色调映射专利可视化工具                      │
├─────────────────┬───────────────────────────────────────────┤
│   参数控制面板   │            可视化和结果显示                │
│                │                                           │
│ • 工作模式选择   │ • Phoenix曲线图表                          │
│ • Phoenix参数   │ • 质量指标显示                            │
│ • 质量指标参数   │ • 时域平滑统计                            │
│ • 时域平滑参数   │ • 系统状态监控                            │
│ • 样条曲线参数   │                                           │
│ • 控制按钮      │                                           │
├─────────────────┴───────────────────────────────────────────┤
│                    图像处理界面                              │
│                                                            │
│  图像上传区域  │  处理结果显示  │  统计信息对比              │
└─────────────────────────────────────────────────────────────┘
```

### 参数控制面板

#### 工作模式
- **自动模式**: 系统根据图像特征自动计算最优参数
- **艺术模式**: 用户手动调节参数进行创意控制

#### Phoenix曲线参数
- **亮度控制因子 p** (0.1-6.0): 控制曲线整体形状，值越大对比度越强
- **缩放因子 a** (0.0-1.0): 控制曲线缩放程度，影响亮度映射范围

#### 质量指标参数
- **失真下阈值 D_T_low** (0.01-0.15): 模式推荐的下阈值
- **失真上阈值 D_T_high** (0.05-0.20): 模式推荐的上阈值
- **亮度通道**: MaxRGB或Y通道选择

#### 时域平滑参数
- **时域窗口大小 M** (5-15): 时域平滑的窗口长度（帧数）
- **平滑强度 λ** (0.1-0.8): 时域平滑的强度系数

#### 样条曲线参数（可选）
- **启用样条曲线**: 开启多段样条曲线局部优化
- **节点位置**: TH1, TH2, TH3三个控制节点
- **样条强度**: 样条曲线与Phoenix曲线的混合比例

## 功能详解

### 1. Phoenix曲线可视化

Phoenix曲线是本工具的核心算法，基于专利技术实现HDR色调映射。

**数学公式**: `L' = L^p / (L^p + a^p)`

**参数说明**:
- `L`: 输入亮度（PQ域，0-1范围）
- `L'`: 输出亮度（PQ域，0-1范围）
- `p`: 亮度控制因子，控制曲线形状
- `a`: 缩放因子，控制映射范围

**实时可视化特性**:
- 参数调节时曲线实时更新（<500ms响应）
- 自动端点归一化确保输出范围[0,1]
- 单调性验证保证映射的合理性
- 数值稳定性处理避免计算错误

### 2. 质量指标计算

系统提供多种质量指标来评估色调映射效果：

#### 感知失真 D'
- **定义**: 衡量映射前后图像的感知差异
- **计算**: 基于PQ域的方差变化
- **范围**: 0-1，值越小表示失真越小

#### 局部对比度
- **定义**: 衡量图像的局部细节保持程度
- **计算**: 基于梯度幅值的统计
- **应用**: 评估细节保持效果

#### 模式推荐
- **自动模式**: 适用于低失真场景（D' < 0.05）
- **艺术模式**: 适用于高失真场景（D' > 0.10）
- **滞回特性**: 中间区间保持上次决策，避免频繁切换

### 3. 图像处理管线

#### 支持的图像格式
- **HDR格式**: EXR, HDR, TIFF (16/32位)
- **标准格式**: PNG, JPEG, BMP
- **颜色空间**: sRGB, Rec.2020, 自动检测

#### 处理流程
1. **图像加载**: 自动格式检测和解码
2. **颜色空间转换**: 转换到PQ域进行处理
3. **亮度提取**: MaxRGB或Y通道提取
4. **色调映射**: 应用Phoenix曲线变换
5. **颜色重建**: 保持色度的颜色重建
6. **显示转换**: 转换到显示设备色彩空间

#### 性能优化
- **自动降采样**: 大图像自动降采样提高响应速度
- **进度指示**: 实时显示处理进度
- **非阻塞UI**: 处理过程中界面保持响应

### 4. 状态管理

#### 会话状态
- **参数设置**: 所有用户调节的参数
- **工作模式**: 当前选择的工作模式
- **界面状态**: 界面元素的状态

#### 时域状态
- **历史参数**: 多帧参数变化历史
- **平滑统计**: 方差降低等统计信息
- **时间戳**: 参数变化的时间记录

#### 自动保存/加载
- **自动保存**: 参数变化时自动保存状态
- **会话恢复**: 重启应用时自动恢复上次状态
- **状态验证**: 加载时验证状态一致性

### 5. 数据导出

#### LUT导出 (.cube格式)
- **用途**: 用于视频编辑软件和调色工具
- **精度**: 支持256-4096采样点
- **兼容性**: 兼容DaVinci Resolve, Premiere Pro等

#### CSV导出
- **内容**: 完整的曲线数据和参数信息
- **用途**: 数据分析和第三方工具集成
- **格式**: 标准CSV格式，包含元数据

#### 诊断包导出
- **内容**: 完整的系统状态和处理信息
- **用途**: 问题诊断和技术支持
- **格式**: ZIP压缩包，包含多种格式文件

## 使用示例

### 示例1: 基础HDR图像处理

1. **准备图像**
   - 准备一张HDR图像（推荐EXR格式）
   - 图像分辨率建议在4MP以内以获得最佳性能

2. **上传和分析**
   ```
   1. 点击"上传HDR图像"
   2. 选择图像文件
   3. 查看"图像信息"显示的统计数据
   ```

3. **参数调节**
   ```
   1. 选择"艺术模式"
   2. 调节"亮度控制因子 p"到2.0
   3. 调节"缩放因子 a"到0.5
   4. 观察曲线变化和质量指标
   ```

4. **处理和导出**
   ```
   1. 点击"处理图像"
   2. 查看处理结果和统计对比
   3. 点击"导出数据"保存LUT文件
   ```

### 示例2: 自动模式使用

1. **切换到自动模式**
   ```
   1. 选择"自动模式"
   2. 上传图像后系统自动分析
   3. 查看"估算信息"显示的参数
   ```

2. **应用自动参数**
   ```
   1. 点击"应用自动参数"
   2. 观察参数自动调整
   3. 查看质量指标变化
   ```

3. **微调和优化**
   ```
   1. 在自动参数基础上微调
   2. 观察实时效果变化
   3. 找到最佳参数组合
   ```

### 示例3: 样条曲线优化

1. **启用样条功能**
   ```
   1. 勾选"启用样条曲线"
   2. 调节三个节点位置
   3. 设置样条强度
   ```

2. **观察效果**
   ```
   1. 对比Phoenix曲线和最终曲线
   2. 查看单调性验证结果
   3. 调节参数优化效果
   ```

### 示例4: 批量处理工作流

1. **设置标准参数**
   ```
   1. 使用代表性图像调节参数
   2. 保存状态作为模板
   3. 记录最佳参数组合
   ```

2. **批量应用**
   ```
   1. 加载保存的状态
   2. 逐个处理图像
   3. 导出统一格式的LUT
   ```

## 常见问题

### Q1: 为什么曲线更新很慢？
**A**: 检查以下几点：
- 确保Python版本≥3.8
- 检查是否安装了NumPy的优化版本
- 尝试降低曲线采样密度
- 检查系统内存使用情况

### Q2: 上传的图像无法处理？
**A**: 可能的原因：
- 图像格式不支持（支持EXR, HDR, PNG, JPEG等）
- 图像文件损坏或格式异常
- 图像过大导致内存不足
- 颜色空间信息缺失

### Q3: 导出的LUT在其他软件中效果不对？
**A**: 检查以下设置：
- 确认目标软件的LUT格式要求
- 检查颜色空间设置是否匹配
- 验证LUT采样点数设置
- 确认输入输出范围设置

### Q4: 自动模式参数不合理？
**A**: 自动模式基于图像统计，可能需要：
- 确保图像是真正的HDR内容
- 检查图像的动态范围
- 手动微调自动参数
- 使用艺术模式进行精细控制

### Q5: 系统提示数值不稳定？
**A**: 这通常发生在极端参数下：
- 避免使用过大的p值（>5.0）
- 检查a值是否在合理范围内
- 使用系统推荐的参数范围
- 查看错误提示的具体建议

### Q6: 如何获得最佳性能？
**A**: 性能优化建议：
- 使用较小的图像进行参数调节
- 启用自动降采样功能
- 关闭不必要的样条曲线功能
- 定期清理临时文件

## 技术规格

### 计算精度
- **曲线计算**: Float64双精度
- **图像处理**: Float32单精度
- **参数存储**: Float64双精度
- **导出精度**: 可配置（6-10位小数）

### 性能指标
- **曲线更新**: <500ms (512采样点)
- **图像处理**: <300ms (1MP图像)
- **参数验证**: <10ms
- **状态保存**: <100ms

### 内存使用
- **基础运行**: ~100MB
- **图像处理**: +图像大小×4倍
- **曲线计算**: +采样点数×8字节
- **状态存储**: <1MB

### 文件格式
- **状态文件**: JSON格式，UTF-8编码
- **LUT文件**: Adobe .cube格式
- **CSV文件**: 标准CSV，UTF-8编码
- **诊断包**: ZIP压缩包

### 兼容性
- **Python**: 3.8+ (推荐3.9+)
- **NumPy**: 1.19+ (推荐1.21+)
- **Gradio**: 3.0+ (推荐最新版)
- **浏览器**: Chrome 80+, Firefox 75+, Safari 13+

---

**版本**: 1.0  
**更新日期**: 2025-10-27  
**技术支持**: 请参考项目文档或提交Issue