# HDR色调映射工具 - 界面布局优化说明

## 优化目标

解决原界面"操作区"和"反馈区"割裂的问题，实现调参时不需要上下滚动就能看到关键结果。

## 新布局：三栏四区结构

### 总体布局

```
┌───────────┬─────────────────────────────┬─────────────────────┐
│ 参数控制区 │ 曲线与指标区                │ 图像与统计区         │
│ (左栏25%) │ (中栏45%)                   │ (右栏30%)           │
│           │                             │                     │
│ 工作模式   │ Phoenix + 样条曲线          │ 原图 → 结果         │
│ Phoenix   │ ┌─────────────────────┐    │ ┌────┬────┐        │
│ 参数      │ │   曲线图             │    │ │原图│结果│        │
│ 样条曲线   │ └─────────────────────┘    │ └────┴────┘        │
│ 时域平滑   │ D′ | 模式 | 亮度漂移        │                     │
│           │                             │ 统计信息            │
│ 控制按钮   │ HDR质量评估                 │ ├ 原始              │
│           │ 🟢 高光饱和 | DR | 直方图    │ └ 处理后            │
│           │ → 综合判定：正常             │                     │
│           │                             │ 导出                │
│           │ PQ直方图对比                │                     │
│           │ ┌─────────────────────┐    │                     │
│           │ │  输入/输出分布       │    │                     │
│           │ └─────────────────────┘    │                     │
└───────────┴─────────────────────────────┴─────────────────────┘
```

## 详细改进

### 左栏：参数控制区 (25%)

**优化前问题：**
- 参数分散在多个区域
- 滑块占用空间大
- 不常用参数也全部展开

**优化后方案：**

1. **工作模式** - 顶部显著位置
   - 自动/艺术模式切换
   - Auto模式估算值紧凑显示（p, a, 置信度）

2. **Phoenix参数块** - 核心参数
   - p, a 滑块并排显示
   - 模式切换阈值折叠（默认收起）

3. **样条曲线块** - 可选功能
   - 折叠面板，默认收起
   - TH1, TH2, TH3 三个滑块一行显示
   - 强度滑块独立一行

4. **时域平滑块** - 视频功能
   - 折叠面板，默认收起
   - 仅视频测试时展开

5. **控制按钮区** - 底部
   - 重置、应用自动、处理图像
   - 小尺寸按钮，节省空间

### 中栏：曲线与指标区 (45%)

**优化前问题：**
- 曲线和指标分离
- 质量评估信息过于详细
- 需要滚动才能看到直方图

**优化后方案：**

1. **曲线区** - 顶部主要区域 (70%高度)
   - Phoenix + 样条叠加曲线（颜色区分）
   - 曲线下方紧凑指标条：
     ```
     🟢 感知失真 D′ = 0.088 | 模式建议：艺术模式 | 亮度漂移：14.6%
     ```
   - 语义化颜色：
     - D′ < 0.05 → 🟢 "自然"
     - 0.05–0.10 → 🟡 "轻调整"
     - > 0.10 → 🔴 "明显变化"

2. **HDR质量评估** - 简化为综合语义条
   ```
   🟢 高光饱和 7.8% | 动态范围保持 0.76 | 直方图重叠 10.1%
   → 综合判定：正常
   ```
   - 可点开查看详细表格（折叠面板）

3. **PQ直方图对比** - 底部 (30%高度)
   - 输入/输出叠加线图
   - 紧凑显示，无需滚动

4. **调试区** - 折叠面板
   - 所有调试信息移到折叠面板
   - 包括：系统状态、性能监控、错误信息

### 右栏：图像与统计区 (30%)

**优化前问题：**
- 原图和结果分离显示
- 统计信息占用大量空间
- 导出功能不明显

**优化后方案：**

1. **图像浏览** - 上半部分
   - 原图和结果并排显示（slider overlay模式）
   - 点击切换对比
   - 紧凑高度（200px）

2. **统计信息** - 折叠面板
   - Tab切换：原始 / 处理后
   - 默认展开，可折叠节省空间

3. **导出与报告** - 底部
   - 格式选择 + 导出按钮
   - 支持 JSON / CSV / LUT / 诊断包

## 信息优先级

| 级别 | 模块 | 说明 | 位置 |
|------|------|------|------|
| 一级 | Phoenix参数、曲线图、HDR质量条、图像结果 | 核心交互 | 始终可见 |
| 二级 | 样条曲线参数、PQ直方图、质量细节表 | 调优辅助 | 可见或一键展开 |
| 三级 | 时域平滑、系统状态、Auto置信度 | 调试维护 | 折叠面板 |

## 交互优化

### 同步更新
- p, a 滑块调节时，曲线、PQ直方图、D′ 同步刷新
- 无需点击"应用"按钮

### 阈值提示
- 当 D′ 超过 D_T_high 时，曲线区域出现红色边框
- 质量指标条颜色变化

### 折叠逻辑
- 样条参数与时域参数默认收起
- 系统状态和Auto信息移到调试区
- 用户可根据需要展开

## 屏幕占比建议 (1920×1080)

| 区域 | 宽度占比 | 高度占比 | 功能 |
|------|----------|----------|------|
| 左栏 参数区 | 25% | 100% | 输入控制 |
| 中栏 曲线+指标 | 45% | 70% | 算法反馈 |
| 中栏 PQ直方图 | 45% | 30% | 分布验证 |
| 右栏 图像+统计 | 30% | 100% | 视觉验证 |

## 实现细节

### CSS优化
- 紧凑间距：组件间距从15px减少到8px
- 小尺寸按钮：padding 4px 12px, font-size 13px
- 优化滑块：margin 4px 0
- 图表圆角：border-radius 4px

### Gradio组件
- 使用 `gr.Accordion` 管理可折叠区
- 使用 `gr.Row()` + `gr.Column()` 实现并排布局
- 使用 `gr.Tabs` 切换统计信息
- 使用 `gr.HTML` 动态渲染质量指标

### 性能优化
- 曲线与直方图共用 Matplotlib 子图
- 图像显示使用固定高度（200px）
- 折叠面板延迟加载

## 使用效果

调试时你能做到：
- ✅ 左手滑动参数，右眼看曲线和指标
- ✅ 下方即时看直方图与图像结果
- ✅ 所有核心指标一屏可见，无需滚动
- ✅ 调参即反馈，操作流畅

## 向后兼容

- 保留所有原有功能
- 所有API接口不变
- 仅调整UI布局和显示方式
- 隐藏的组件仍然存在（visible=False）

## 测试方法

```bash
# 启动新布局
python test_new_layout.py

# 访问
http://localhost:7860
```

## 反馈与改进

如需进一步调整：
1. 修改 `_get_custom_css()` 调整样式
2. 修改 `scale` 参数调整栏宽比例
3. 修改 `Accordion(open=...)` 调整默认展开状态
4. 修改 `height` 参数调整图像显示高度
