# HDR质量评估扩展模块需求文档

## 简介

本文档定义了HDR色调映射专利可视化工具的质量评估扩展模块需求。该模块旨在为现有系统补充客观的质量指标、直方图可视化和艺术家友好的提示功能，帮助用户判断HDR色调映射结果的质量。

## 术语表

- **HDR系统**: HDR色调映射专利可视化工具主系统
- **Phoenix曲线**: 现有的核心色调映射算法
- **Lin**: 输入亮度数据（PQ域，范围0-1）
- **Lout**: 输出亮度数据（PQ域，映射后，范围0-1）
- **ExtendedMetrics**: 扩展质量评估模块类
- **PQ直方图**: 感知量化直方图显示组件
- **质量指标区**: 界面右侧显示质量数据的区域
- **艺术家模式**: 面向非技术用户的语义化提示模式
- **质量摘要区**: 显示状态标签和关键指标的UI组件

## 需求

### 需求1：质量指标计算

**用户故事：** 作为HDR图像处理专家，我希望获得量化的质量评估指标，以便客观判断色调映射的效果。

#### 验收标准

1. 当HDR系统完成色调映射处理时，ExtendedMetrics应当在PQ域计算基础统计数据（Lmin_in、Lmax_in、Lmin_out、Lmax_out）
2. 当ExtendedMetrics接收Lin和Lout数据时，ExtendedMetrics应当计算曝光相关指标（S_ratio、C_shadow、R_DR、ΔL_mean_norm）
3. 当ExtendedMetrics执行直方图分析时，ExtendedMetrics应当计算直方图重叠度（Hist_overlap）
4. 当所有指标计算完成时，ExtendedMetrics应当输出统一的JSON格式数据，数值格式为小数（如0.078）
5. 当指标计算过程中出现数值异常时，ExtendedMetrics应当使用1e-6作为除零保护
6. 当指标计算时，ExtendedMetrics应当在30ms内完成处理（1MP图像参考值）

### 需求2：自动质量评估

**用户故事：** 作为图像处理用户，我希望系统能自动判断映射结果是否过曝、过暗或异常，以便快速了解处理质量。

#### 验收标准

1. 当S_ratio大于阈值或Dprime大于阈值时，HDR系统应当标记状态为"过曝"
2. 当C_shadow大于阈值时，HDR系统应当标记状态为"过暗"
3. 当R_DR偏离1.0超过阈值时，HDR系统应当标记状态为"动态范围异常"
4. 当所有指标都在正常范围内时，HDR系统应当标记状态为"正常"
5. 当状态确定后，质量摘要区应当显示对应的颜色编码和文本（正常🟢、略亮🟡、过曝🔴、暗压🟣、异常⚪）
6. 当系统启动时，HDR系统应当从config/metrics.json读取判定阈值配置

### 需求3：PQ直方图可视化修复

**用户故事：** 作为视觉分析用户，我希望看到修复后的PQ直方图对比，以便直观了解映射前后的亮度分布变化。

#### 验收标准

1. 当process_image_with_progress成功完成时，PQ直方图应当使用Lin和Lout数据重新绘制
2. 当直方图绘制时，PQ直方图应当显示输入和输出两条曲线，分别标记为"Input"和"Output"
3. 当直方图更新时，PQ直方图应当使用256个bins和(0,1)范围进行归一化（使用density参数）
4. 当用户切换参数但未处理图像时，PQ直方图应当保持当前显示不变
5. 当直方图显示时，PQ直方图应当包含图例说明"原始/处理后PQ直方图对比"

### 需求4：质量摘要显示

**用户故事：** 作为普通用户，我希望在界面上看到简洁的质量摘要信息，以便快速了解处理结果的关键指标。

#### 验收标准

1. 当质量指标计算完成时，质量摘要区应当显示高光饱和比例（JSON中0.078显示为7.8%）
2. 当质量指标计算完成时，质量摘要区应当显示暗部压缩比例（JSON中0.021显示为2.1%）
3. 当质量指标计算完成时，质量摘要区应当显示动态范围保持率（JSON中1.21显示为1.21）
4. 当质量指标计算完成时，质量摘要区应当显示亮度漂移（JSON中1.38显示为138%）
5. 当综合判断完成时，质量摘要区应当在DOM元素id="quality-status"中显示带颜色编码的状态标识

### 需求5：艺术家模式语义提示

**用户故事：** 作为艺术创作者，我希望获得易懂的语义化建议，以便调整参数优化图像效果。

#### 验收标准

1. 当系统检测到过曝问题时，HDR系统应当提供减小p参数或增大a参数的建议
2. 当系统检测到过暗问题时，HDR系统应当提供相应的参数调整建议
3. 当艺术家模式激活时，HDR系统应当在DOM元素id="artist-tips"中显示当前指标的具体数值和建议目标区间
4. 当提供建议时，HDR系统应当使用中文语义化表达（仅限提示文本）
5. 当建议生成时，HDR系统应当基于D'≈0.10～0.20的目标区间给出指导

### 需求6：数据导出和集成

**用户故事：** 作为研究人员，我希望导出完整的质量评估数据，以便进行后续分析和论文撰写。

#### 验收标准

1. 当质量评估完成时，HDR系统应当将所有指标写入现有的JSON输出结构
2. 当数据导出时，HDR系统应当保持与现有数据格式的兼容性
3. 当集成到主处理流程时，ExtendedMetrics应当不影响Phoenix曲线的核心计算逻辑
4. 当模块加载时，HDR系统应当能够正常导入metrics_extension.py模块
5. 当批量处理时，HDR系统应当在一次映射后批量计算所有质量指标
6. 当JSON导出时，HDR系统应当使用以下标准格式：

```json
{
  "Lmin_in": 0.02,
  "Lmax_in": 0.98,
  "Lmin_out": 0.01,
  "Lmax_out": 0.94,
  "S_ratio": 0.078,
  "C_shadow": 0.021,
  "R_DR": 1.21,
  "ΔL_mean_norm": 1.38,
  "Hist_overlap": 0.41,
  "Exposure_status": "过曝"
}
```
### 需求7：配置管理
#### 用户故事： 作为系统管理员，我希望能够调整质量评估的判定阈值，以便适应不同的应用场景。

#### 验收标准
1. 当配置文件不存在时，HDR系统应当使用默认阈值（S_ratio: 0.05, C_shadow: 0.10, R_DR_tolerance: 0.2, Dprime: 0.25）
2. 当配置文件更新时，HDR系统应当支持热更新阈值设置（详见需求2.6的阈值来源）
3. 当阈值配置无效时，HDR系统应当回退到默认值并记录警告日志
4. 当配置读取时，HDR系统应当验证所有阈值在合理范围内（0-1之间）